# 架构概览

本示例描述一种“双入口 + 回程隧道”的 OpenVPN 部署：

- **主服务器（云端）**：提供公网入口，监听 `UDP/1194`，统一地址池 `10.8.0.0/24`。
- **辅服务器（局域网）**：部署在内网，例如家用网关或办公室 Mac mini，监听 `UDP/1195`，共享同一地址池。
- **后端隧道**：两台服务器间再建一条专用 OpenVPN 隧道（例如 `10.255.0.0/30`），用于回程转发。
- **CCD 固定地址**：所有客户端通过 `client-config-dir` 获得固定的 `10.8.0.x` 地址，不论连到哪台服务器都保持不变。
- **动态路由同步**：利用 `learn-address` 或自定义 webhook，把客户端上线/下线事件同步为 `/32` 路由，从而实现跨入口互访。

> 说明：文档仅提供思路，实际的 IP、端口、证书文件路径需根据环境自行调整。

## 部署步骤摘要

1. 初始化 PKI（CA、服务器证书、客户端证书）。
2. 在云端部署 `server.conf`（参考 `server.conf.example`）。
3. 在辅服务器部署第二个 OpenVPN 实例，复用同一 CA/CCD。
4. 为两个实例配置 `learn-address` 钩子，调用 `scripts/route-sync-*.sh` 动态更新路由。
5. 在客户端 `.ovpn` 中设置多个 `remote` 条目（内网 → 公网优先级），并启用 `verify-x509-name` 与 `tls-crypt` 等安全选项。

## 目录与职责

| 目录/文件 | 作用 | 是否包含敏感信息 |
|-----------|------|------------------|
| `server.conf.example` | 云端 OpenVPN 模板 | 否 |
| `launchd/` | macOS launchd 样例 | 否 |
| `scripts/` | 同步、路由、自动化脚本 | 否（依赖 `.env`） |
| `client/`, `keys/`, `backup/` | **未纳入 Git**，在真实环境中存放敏感数据 | 是 |

## 安全实践

- 所有机密（证书、私钥、压缩备份、生产路径）必须保存在 `.gitignore` 覆盖的目录中。
- `.env` 仅存放环境变量，部署前请限制权限（`chmod 600 .env`）。
- 每次推送公共仓库前执行 `git status`，确认没有敏感文件被意外跟踪。

